<script>
(function() {
  // ambient hearts (unchanged, keep your existing code)
  const heartContainer = document.getElementById('heartContainer');
  for (let i = 0; i < 24; i++) {
    let heart = document.createElement('div');
    heart.className = 'heart';
    heart.innerHTML = i % 3 === 0 ? 'â¤ï¸' : (i % 3 === 1 ? 'â¤ï¸â€ðŸ”¥' : 'ðŸ’‹');
    heart.style.left = Math.random() * 100 + '%';
    heart.style.animationDelay = Math.random() * 10 + 's';
    heart.style.fontSize = (0.9 + Math.random() * 1.8) + 'rem';
    heart.style.opacity = 0.2 + Math.random() * 0.4;
    heartContainer.appendChild(heart);
  }

  // DOM elements
  const overlay = document.getElementById('kissOverlay');
  const kissText = document.getElementById('kissText');
  const introSec = document.getElementById('intro');
  const kissSec = document.getElementById('kissButtons');
  const choicesDiv = document.getElementById('choices');
  const customPlayerDiv = document.getElementById('customPlayer');
  const floatingMessageDiv = document.getElementById('floatingMessage');
  const storyPlayer = document.getElementById('storyPlayer');

  // audio element (hidden)
  const audio = new Audio();
  audio.src = "assets/sounds/audio1.mp3";  // initial voice note

  // custom player elements
  const playPauseBtn = document.getElementById('playPauseBtn');
  const currentTimeSpan = document.getElementById('currentTime');
  const durationTimeSpan = document.getElementById('durationTime');
  const timeBar = document.getElementById('timeBar');
  const progressFill = document.getElementById('progressFill');
  const volumeControl = document.getElementById('volumeControl');

  let stage = 0;               // 0: after audio1, 1: after first yes
  let finalLock = false;       // if true, no more choices
  let overlayTimeout = null;   // for kiss overlay linger

  // --- helper: show temporary message (for audio errors) ---
  function showToast(msg) {
    const toast = document.createElement('div');
    toast.textContent = msg;
    toast.style.position = 'fixed';
    toast.style.bottom = '30px';
    toast.style.left = '50%';
    toast.style.transform = 'translateX(-50%)';
    toast.style.background = '#ff3366';
    toast.style.color = 'white';
    toast.style.padding = '12px 24px';
    toast.style.borderRadius = '50px';
    toast.style.zIndex = '10000';
    toast.style.fontSize = '1.2rem';
    toast.style.boxShadow = '0 0 30px #ff0066';
    toast.style.backdropFilter = 'blur(10px)';
    toast.style.border = '1px solid #ff99bb';
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  // --- safe play function with error handling ---
  function safePlay(audioObj, fallbackMsg) {
    audioObj.play().catch(err => {
      console.warn('Audio play failed:', err, 'for', audioObj.src);
      showToast(fallbackMsg || 'ðŸ’‹ audio missing (but kiss still there)');
    });
  }

  // ---- custom player logic ----
  function formatTime(seconds) {
    if (isNaN(seconds)) return '0:00';
    const m = Math.floor(seconds / 60);
    const s = Math.floor(seconds % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
  }

  function updatePlayerUI() {
    currentTimeSpan.textContent = formatTime(audio.currentTime);
    durationTimeSpan.textContent = formatTime(audio.duration);
    const percent = (audio.currentTime / (audio.duration || 1)) * 100;
    progressFill.style.width = percent + '%';
  }

  audio.addEventListener('loadedmetadata', () => {
    durationTimeSpan.textContent = formatTime(audio.duration);
  });

  audio.addEventListener('timeupdate', updatePlayerUI);

  audio.addEventListener('ended', () => {
    playPauseBtn.textContent = 'â–¶';
    if (!finalLock && !customPlayerDiv.classList.contains('hidden')) {
      choicesDiv.classList.remove('hidden');
    }
  });

  playPauseBtn.addEventListener('click', () => {
    if (audio.paused) {
      safePlay(audio, 'audio file not found â€“ check path');
      playPauseBtn.textContent = 'â¸';
    } else {
      audio.pause();
      playPauseBtn.textContent = 'â–¶';
    }
  });

  timeBar.addEventListener('click', (e) => {
    const rect = timeBar.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const width = rect.width;
    const percentage = clickX / width;
    if (audio.duration) {
      audio.currentTime = percentage * audio.duration;
    }
  });

  volumeControl.addEventListener('input', (e) => {
    audio.volume = e.target.value;
  });

  // ---- story choices (revised) ----
  window.choose = function(answer) {
    if (finalLock) return;

    choicesDiv.classList.add('hidden');  // hide buttons immediately

    // Stage 0: after audio1
    if (stage === 0) {
      if (answer === 'no') {
        // first no: play no1.mp3 and lock
        audio.src = "assets/sounds/no1.mp3";
        finalLock = true;
        audio.load();
        safePlay(audio, 'no1.mp3 missing');
        playPauseBtn.textContent = 'â¸';
      } else { // yes
        audio.src = "assets/sounds/yes1.mp3";
        stage = 1; // move to next stage
        audio.load();
        safePlay(audio, 'yes1.mp3 missing');
        playPauseBtn.textContent = 'â¸';
      }
    }
    // Stage 1: after first yes
    else if (stage === 1) {
      if (answer === 'yes') {
        // second yes: play yes2.mp3 and lock permanently
        audio.src = "assets/sounds/yes2.mp3";
        finalLock = true;
        audio.load();
        safePlay(audio, 'yes2.mp3 missing');
        playPauseBtn.textContent = 'â¸';
        // after yes2 ends, no further choices (locked)
      } else { // no
        // second no: hide player, show floating message, no audio
        customPlayerDiv.classList.add('hidden');
        floatingMessageDiv.classList.remove('hidden');
        finalLock = true; // lock everything
        // optional: pause any playing audio
        audio.pause();
        playPauseBtn.textContent = 'â–¶';
      }
    }
  };

  // ---- intro ----
  window.startPage = function() {
    introSec.classList.add('hidden');
    kissSec.classList.remove('hidden');
    kissSec.scrollIntoView({ behavior: 'smooth' });
  };

  // ---- kiss effects with 3-second linger ----
  window.playKiss = function(type) {
    let gradient = '';
    if (type === 'soft') gradient = 'linear-gradient(145deg, #440022, #13000c)';
    else if (type === 'quick') gradient = 'linear-gradient(105deg, #2f0025, #0e000b)';
    else if (type === 'playful') gradient = 'linear-gradient(170deg, #3b0025, #080004)';
    else gradient = '#1f0015';
    showOverlay(type + ' kiss', `assets/sounds/${type}.mp3`, gradient);
  };

  window.playFrench = function() {
    const tease = new Audio("assets/sounds/french_tease.mp3");
    safePlay(tease, 'french_tease.mp3 missing (tease)');
    setTimeout(() => {
      showOverlay('french kiss â€¦', "assets/sounds/french.mp3", 'radial-gradient(circle at 30% 40%, #80003b, #1e000b)');
    }, 700);
  };

  function showOverlay(msg, soundSrc, bgStyle) {
    // clear any pending hide timeout
    if (overlayTimeout) clearTimeout(overlayTimeout);

    overlay.style.display = 'flex';
    overlay.style.opacity = '1';
    overlay.style.background = bgStyle;
    kissText.textContent = msg;

    const sfx = new Audio(soundSrc);
    safePlay(sfx, `${soundSrc} not found`);

    sfx.onended = () => {
      // keep overlay for 3 more seconds, then fade out
      overlayTimeout = setTimeout(() => {
        overlay.style.transition = 'opacity 0.5s';
        overlay.style.opacity = '0';
        setTimeout(() => {
          overlay.style.display = 'none';
          overlay.style.opacity = '1'; // reset for next time
          overlay.style.transition = '';
        }, 500);
      }, 3000);
    };
  }

  // heart burst on any button click
  document.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', (e) => {
      for (let i=0; i<4; i++) {
        let h = document.createElement('span');
        h.innerHTML = 'â¤ï¸';
        h.style.position = 'fixed';
        h.style.left = (e.clientX + (Math.random()-0.5)*60) + 'px';
        h.style.top = (e.clientY + (Math.random()-0.5)*60) + 'px';
        h.style.fontSize = '2rem';
        h.style.pointerEvents = 'none';
        h.style.zIndex = '5000';
        h.style.animation = 'rise 1s forwards';
        document.body.appendChild(h);
        setTimeout(() => h.remove(), 900);
      }
    });
  });

  // expose functions globally
  window.showOverlay = showOverlay;
})();
</script>
